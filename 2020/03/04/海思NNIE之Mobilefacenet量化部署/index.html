<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>海思NNIE之Mobilefacenet量化部署 - Hanson&#039;s Happy Days</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hanson&#039;s Happy Days"><meta name="msapplication-TileImage" content="/img/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanson&#039;s Happy Days"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="AI模型部署优化"><meta property="og:type" content="blog"><meta property="og:title" content="海思NNIE之Mobilefacenet量化部署"><meta property="og:url" content="http://example.com/2020/03/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BMobilefacenet%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="Hanson&#039;s Happy Days"><meta property="og:description" content="AI模型部署优化"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://pic4.zhimg.com/v2-41222c094c3f00a034d46ccef7d35dd6_r.jpg"><meta property="article:published_time" content="2020-03-04T09:41:47.000Z"><meta property="article:modified_time" content="2021-06-20T17:23:34.820Z"><meta property="article:author" content="John Doe"><meta property="article:tag" content="nniefacelib"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://pic4.zhimg.com/v2-41222c094c3f00a034d46ccef7d35dd6_r.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2020/03/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BMobilefacenet%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"},"headline":"海思NNIE之Mobilefacenet量化部署","image":["https://pic4.zhimg.com/v2-41222c094c3f00a034d46ccef7d35dd6_r.jpg"],"datePublished":"2020-03-04T09:41:47.000Z","dateModified":"2021-06-20T17:23:34.820Z","author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"Hanson's Happy Days","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.jpg"}},"description":"AI模型部署优化"}</script><link rel="canonical" href="http://example.com/2020/03/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BMobilefacenet%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"><link rel="icon" href="/img/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><script>(function(h,o,t,j,a,r){
            h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
            h._hjSettings={hjid:links,hjsv:6};
            a=o.getElementsByTagName('head')[0];
            r=o.createElement('script');r.async=1;
            r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
            a.appendChild(r);
        })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-8344814726705993" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.jpg" alt="Hanson&#039;s Happy Days" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/hanson-young/HansonBlog"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://pic4.zhimg.com/v2-41222c094c3f00a034d46ccef7d35dd6_r.jpg" alt="海思NNIE之Mobilefacenet量化部署"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-03-04T09:41:47.000Z" title="2020/3/4下午5:41:47">2020-03-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-06-20T17:23:34.820Z" title="2021/6/21上午1:23:34">2021-06-21</time></span><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">29 minutes read (About 4276 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">海思NNIE之Mobilefacenet量化部署</h1><div class="content"><blockquote>
<p>本文首发于我的知乎：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/107548509">https://zhuanlan.zhihu.com/p/107548509</a></p>
</blockquote>
<h1 id="0-前言"><a class="markdownIt-Anchor" href="#0-前言"></a> 0. 前言</h1>
<p>那就直接更新下整理好的代码链接吧！</p>
<p><code>https://github.com/hanson-young/nniefacelib</code></p>
<p>当您点进这篇文章，我想肯定不需要过多的去向您介绍华为海思35xx系列芯片的型号参数或者强大之处。另外这个教程也是建立已经配置好环境，并掌握Ruyi Studio的基本使用前提下的。如果还没有跑过其中的一些sample，网上也有一些教程，推荐看刘山老师的博客（地址为：<code>https://blog.csdn.net/avideointerfaces/article/details/88585654</code>）。</p>
<p>这篇文章的目录如下：</p>
<ul>
<li>简介</li>
<li>目录结构</li>
<li>mobilefacenet.cfg文件的配置</li>
<li>生成NNIE mk模型</li>
<li>Vector Comparision</li>
<li>NNIE mobilefacenet板上特征提取</li>
<li>附录</li>
</ul>
<h1 id="1-简介"><a class="markdownIt-Anchor" href="#1-简介"></a> 1. 简介</h1>
<p>海思35xx系列芯片对比起nvidia TX2、Intel Movidius神经计算棒等一众边缘计算产品，有其惊艳的地方，因其集成了强大的算力模块，集成度和功能模块齐全，最重要的是成本低，成为了安防行业的首选芯片。但是也有一些麻烦的地方，主要是在于其开发难度的提高，大家都是摸着石头过河（3288老玩家转行也是能体会到痛苦的）。在转自己的模型时，坑比想象的要多，并且海思官方SDK也存在一些错误之处，让人很难捉摸，所以有时候需要自己多去独立思考。这次我记录了在转换人脸识别模型mobilefacenet（<code>https://github.com/deepinsight/insightface</code>）下了比较坑的三个点，毕竟是个新玩意儿，多半是版本发布时候不统一造成的：</p>
<ul>
<li>CNN_convert_bin_and_print_featuremap.py 代码出现错误，cfg中的【image_list】这个字段并没有在代码中出现，代码中只有【image_file】，因此需要修改这一地方。</li>
<li>CNN_convert_bin_and_print_featuremap.py和Get Caffe Output这里的预处理方式都是先乘以【data_scale】，再减均值【mean_file】，而在量化生成 .mk 文件时却是先减均值再乘以scale的。</li>
<li>量化需要使用多张图片，而CNN_convert_bin_and_print_featuremap.py各层产生的feature仅仅是一张图片，这在做【Vector Comparision】时候就难以清楚的明白到底最后mk文件是第几张图像。</li>
</ul>
<h1 id="2-目录结构"><a class="markdownIt-Anchor" href="#2-目录结构"></a> 2. 目录结构</h1>
<p><img src="https://img-blog.csdnimg.cn/20200530154354447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="在Ruyi Studio中量化mobilefacenet的目录结构" /></p>
<h1 id="3-mobilefacenetcfg文件的配置"><a class="markdownIt-Anchor" href="#3-mobilefacenetcfg文件的配置"></a> 3. mobilefacenet.cfg文件的配置</h1>
<p>可以从github上下载mxnet2caffe的mobilefacenet模型（<code>https://github.com/honghuCode/mobileFacenet-ncnn/tree/feature/mobilefacenet-mxnet2caffe</code>），首先需要修改mobilefacenet.prototxt（<code>https://github.com/honghuCode/mobileFacenet-ncnn/blob/feature/mobilefacenet-mxnet2caffe/mobilefacenet.prototxt</code>）的输入层以符合NNIE caffe网络的结构标准：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530154625107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="更改前" /><br />
<img src="https://img-blog.csdnimg.cn/20200530154635651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="更改后" /><br />
而量化mk使用的【mean_file】pixel_mean.txt是特别需要注意的</p>
<p><img src="https://img-blog.csdnimg.cn/20200530154651101.png" alt="pixel_mean.txt" /></p>
<p>我从agedb_30人脸数据库里面挑选了10张图像来做量化处理，为什么需要多张量化，请参考文章<code>https://zhuanlan.zhihu.com/p/58182172</code>，我们选择【10.jpg】来做 【Vector Comparision】，其实就是imageList.txt里的排列在最后的那张图片</p>
<p><img src="https://img-blog.csdnimg.cn/20200530154730952.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="做量化的校验集" /><br />
具体配置如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530154755958.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="mobilefacenet.cfg文件的配置视图" /></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">[prototxt_file] ./mark_prototxt/mobilefacenet_mark_nnie_20190723102335.prototxt<br>[caffemodel_file] ./data/face/mobilefacenet.caffemodel<br>[batch_num] 256<br>[net_type] 0<br>[sparse_rate] 0<br>[compile_mode] 0<br>[is_simulation] 0<br>[log_level] 3<br>[instruction_name] ./data/face/mobilefacenet_inst<br>[RGB_order] RGB<br>[data_scale] 0.0078125<br>[internal_stride] 16<br>[image_list] ./data/face/images/imageList20190723102419.txt<br>[image_type] 1<br>[mean_file] ./data/face/pixel_mean.txt<br>[norm_type] 5<br></code></pre></td></tr></table></figure>
<h1 id="4-生成nnie-mk模型"><a class="markdownIt-Anchor" href="#4-生成nnie-mk模型"></a> 4. 生成NNIE mk模型</h1>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">Start [RuyiStudio Wk NNIE Mapper] [E:\Code\nnie\windows\RuyiStudio-2.0.31\workspace\HeilsFace\mobilefacenet.cfg] HeilsFace (2019-07-23 10:48:17)<br>Mapper Version 1.1.2.0_B050 (NNIE_1.1) 1812171743151709<br>begin net parsing....<br>.end net parsing<br>begin prev optimizing....<br>....end prev optimizing....<br>begin net quantalizing(GPU)....<br><br><br>....................**********************************************************<br>WARNING: file: Inference::computeNonlinearQuantizationDelta  line: 92<br>data containing only zeros; <span class="hljs-built_in">set</span> max value to 1e-6.<br>**********************************************************<br>WARNING: file: Inference::computeNonlinearQuantizationDelta  line: 92<br>data containing only zeros; <span class="hljs-built_in">set</span> max value to 1e-6.<br>.......................................<br><br><br>end quantalizing<br>begin optimizing....<br>.end optimizing<br>begin NNIE[0] mem allocation....<br>...end NNIE[0] memory allocating<br>begin NNIE[0] instruction generating....<br>.............end NNIE[0] instruction generating<br>begin parameter compressing....<br>.end parameter compressing<br>begin compress index generating....<br>end compress index generating<br>begin binary code generating....<br>...................................................................................<br>...................................................................................<br>..................................................................................<br>...................................................................................<br>.............end binary code generating<br>begin quant files writing....<br>end quant files writing<br>===============E:\Code\nnie\windows\RuyiStudio-2.0.31\workspace\HeilsFace\mobilefacenet.cfg Successfully!===============<br></code></pre></td></tr></table></figure>
<p>结束之后会生成：</p>
<ul>
<li>mobilefacenet_inst.wk文件</li>
<li>mapper_quant文件夹，里面有量化输出的结果，如图 Fig.4.1，也就是./data/face/images/10.jpg</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20200530154948256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.4.1 [image_list]./data/face/images/imageList20190723102419.txt" /></p>
<p><strong>记住，mk量化过程在【mapper_quant】文件夹中生成的features是最后一张图片的inference结果，这也是文章最开始说的第三个存在问题的地方</strong></p>
<h1 id="5-vector-comparision"><a class="markdownIt-Anchor" href="#5-vector-comparision"></a> 5. Vector Comparision</h1>
<p>这一步，主要就是对比量化前后模型输出的精度损失，<strong>最重要的就是要debug一遍CNN_convert_bin_and_print_featuremap.py</strong></p>
<p>因为这个脚本里确实藏了很多雷，我们先要比较原框架原模型inference的结果与这一脚本得出来的结果是否一致，如果存在不一致的情况，需要去核查一遍原因</p>
<p>文章开篇说到的第一个问题点 CNN_convert_bin_and_print_featuremap.py 中加载了mobilefacenet.cfg文件，<strong>但脚本中并不存在【image_list】这个字段，取而代之的是【image_file】这个字段</strong></p>
<p>生成NNIE mk中，mobliefacenet.cfg 的【image_list】：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155058357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.5.1 生成NNIE mk中的mobliefacenet.cfg" /></p>
<p>CNN_convert_bin_and_print_featuremap.py 中加载.cfg代码片段：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155117291.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="CNN_convert_bin_and_print_featuremap.py 中加载.cfg代码片段：" /></p>
<p>因此需要根据实际情况修改 mobliefacenet.cfg ，这里最好是复制一份新的，旧的用于生成NNIE wk，在复制后的mobliefacenet.cfg中修改一下：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155143281.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="修改后的mobliefacenet.cfg" /></p>
<p>另外，我们需要特别注意预处理这一个环节，如文章开篇所阐述的第二点</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155237775.png" alt="预处理" /></p>
<p>我们注意到这里，data是uint8类型的array，是先乘以了【data_scale】的，也就是说和NNIE 生成wk中的操作顺序是不一致的。</p>
<p><strong>(data - 128.0) * 0.0078125 &lt;==&gt; data * 0.0078125 - 1</strong></p>
<p>因此这里需要做的修改就是需要将【mean_file】pixel_mean.txt修改为</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155257932.png" alt="修改后的mean_file" /></p>
<p>修改完以上，然后直接运行代码，将最终模型提取的features fc1_output0_128_caffe.linear.float和caffe_forward.py（<code>https://github.com/honghuCode/mobileFacenet-ncnn/blob/feature/mobilefacenet-mxnet2caffe/caffe_forward.py</code>）中的进行比对，如果以上都没问题，可以看到结果是几乎一致的</p>
<p>caffe_forward.py生成的结果：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">[-0.82475293 -0.33066949 -0.9848339   2.44199681  0.41715512  0.67809981<br>  0.29879519  1.14293635 -0.42905819  0.32940909 -1.20455348  1.01217067<br>  0.83146936 -0.84349883 -1.49177814 -0.91509151 -1.39441037  0.00413842<br>  0.97043389 -1.77688181  0.28639579 -1.06645989 -0.8570649  -2.09743094<br> -0.1394622  -1.15035641 -0.81590587 -3.93798804 -0.35600579  1.90367532<br>  1.27935755 -2.07778478 -0.42563218  0.06624207  1.02597868 -0.52002895<br> -0.905873   -0.41364694 -1.40032899 -1.37654066  0.03066693 -0.18659458<br> -1.53931415 -0.55896652  2.42570448 -0.3044413   0.18183242  0.50442797<br> -2.36735368 -0.12376076  0.15200013  0.13939141  0.56305337 -0.10047323<br>  1.50704932  0.05429612 -1.97527623 -0.75790995  1.89399767  0.56089604<br> -2.34883094  0.22600658  1.00399816 -0.55099922  1.77083731  0.10722937<br>  2.21140814  0.06182361  0.03354079  0.97481596 -2.00423741  0.73168194<br> -1.79977489 -0.85182911 -0.06020565 -0.14835797 -1.93012297 -3.09269047<br> -0.60087907 -1.02915597  1.40985525  1.85411906 -1.21282506 -2.53264689<br> -0.63467324 -1.15255475 -0.59994221  0.21181655  1.30336523 -1.73625863<br>  0.00861333  0.99906266  1.90666902  0.51179212  0.62143475  1.01997399<br> -1.65181398  1.55190873  0.43448481 -0.85371047 -0.68216199  1.28038061<br>  0.4629558  -0.59671575  1.00122356  1.74233603  1.50384009  0.49827856<br>  0.67030573 -1.20388556  1.00168729 -0.71768999  1.06416941 -2.55346298<br> -1.85579956 -2.18774438 -1.79652691  1.50856853  2.10628557  1.12313557<br>  2.76396179  0.60242128  0.0550903  -1.31998527 -0.6896565  -0.07160443<br>  1.21242583 -1.06733179]<br></code></pre></td></tr></table></figure>
<p>CNN_convert_bin_and_print_featuremap.py生成的结果（由于特征值太多，就不一一打印出来了）：</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155526708.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="caffe_forward.py生成的结果：" /></p>
<p><strong>然后再生成，并进行【Vector Comparision】，量化终于成功了</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200530155644744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="中间层特征值比较图1" /><br />
<img src="https://img-blog.csdnimg.cn/20200530155652426.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="中间层特征值比较图2" /><br />
<img src="https://img-blog.csdnimg.cn/20200530155659125.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="中间层特征值比较图3" /></p>
<h1 id="6-nnie-mobilefacenet板上特征提取"><a class="markdownIt-Anchor" href="#6-nnie-mobilefacenet板上特征提取"></a> 6. NNIE mobilefacenet板上特征提取</h1>
<p>做完了模型的量化，就可以进行仿真或者是在板子上进行实际测试了，这一步的坑并不是很多，主要还是得靠一些编程技巧了，建议熟悉C语言，这部分要熟悉sample代码，如果说非常熟悉c/c<ins>混编，也可以使用c</ins>。</p>
<h2 id="61-修改例程"><a class="markdownIt-Anchor" href="#61-修改例程"></a> 6.1 修改例程</h2>
<p>这里参考了<code>https://blog.csdn.net/u011728480/article/details/92069793</code>，其写法几乎一致，如下Fig.6.1 Fig.6.2是我所修改的代码片段，找到smp/a7_linux/mpp/sample/svp/nnie/sample/sample_nnie.c中该函数</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SAMPLE_SVP_NNIE_Cnn</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br></code></pre></td></tr></table></figure>
<p>只用修改了该函数的前后两处代码</p>
<p><img src="https://img-blog.csdnimg.cn/20200530155849263.png" alt="Fig.6.1 函数开头修改pcSrcFile和pcModeName" /><br />
<img src="https://img-blog.csdnimg.cn/20200530155857641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.2 函数结尾增加输出层的打印信息" /></p>
<p>我们调用了 SAMPLE_SVP_NNIE_PrintReportResult 函数输出两个结果报表文件，结果分析当中会用到</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">seg0_layer38_output0_inst.linear.hex<br>seg0_layer3605_output0_inst.linear.hex<br></code></pre></td></tr></table></figure>
<p>整段函数代码参见文章末尾【附录】</p>
<h2 id="62-bgr文件的生成"><a class="markdownIt-Anchor" href="#62-bgr文件的生成"></a> 6.2 bgr文件的生成</h2>
<p>注意到上文中我使用了pcSrcFile，这也是例程中主流的格式bgr，那么我们一般的图片都是.jpeg格式的，为了更好的利用NNIE，所以就需要利用opencv来转化以下。</p>
<p>首先.bgr文件是可以由opencv Mat转换的，但完成转换代码的编写之前我们必须清楚像素的空间排列顺序。注意，以下转换代码简单采用像素复制，并没有考虑优化，运行会比较慢！参考博客</p>
<p>.bgr ==&gt; BBBBBB…GGGGGG…RRRRRR</p>
<p>cv::Mat ==&gt; BGRBGRBGR…BGRBGRBGR</p>
<p><strong>.bgr --&gt; cv::Mat</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200530155951657.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.3 .bgr 转 mat" /></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*bgr格式 转 cv::Mat代码 */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bgr2mat</span><span class="hljs-params">(cv::Mat&amp; img, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height, <span class="hljs-keyword">int</span> channel, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* pth)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (pth)<br>	&#123;<br>		FILE* fp;<br>		<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *img_data = <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *img_data_conv = <span class="hljs-literal">NULL</span>;<br>		img_data = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>) * width * height * channel);<br>		<span class="hljs-comment">//unsigned char img_data[300 * 300 * 3];</span><br>		img_data_conv = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>) * width * height * channel);<br><br>		fp = <span class="hljs-built_in">fopen</span>(pth, <span class="hljs-string">&quot;rb&quot;</span>);<br>		<span class="hljs-keyword">if</span> (!fp)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		&#125;<br>		<span class="hljs-built_in">fread</span>(img_data, <span class="hljs-number">1</span>, width * height * channel, fp);<br>		<span class="hljs-built_in">fclose</span>(fp);<br><br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> k = <span class="hljs-number">0</span>; k &lt; channel; k++)<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; height; i++)<br>				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; width; j++)<br>					img_data_conv[channel * (i * width + j) + k] = img_data[k * height * width + i * width + j];<br>		img = cv::<span class="hljs-built_in">Mat</span>(height, width, CV_8UC3, img_data_conv);<br>		<span class="hljs-comment">//free(img_data_conv);</span><br>		<span class="hljs-comment">//img_data_conv = NULL;</span><br>		<span class="hljs-built_in">free</span>(img_data);<br>		img_data = <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>cv::Mat --&gt;.bgr</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200530160020177.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.4 mat转.bgr" /></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*cv::Mat 转 bgr格式代码 */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">mat2bgr</span><span class="hljs-params">(cv::Mat&amp; img, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* bgr_path)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (bgr_path)<br>	&#123;<br>		FILE* fp = <span class="hljs-built_in">fopen</span>(bgr_path, <span class="hljs-string">&quot;wb&quot;</span>);<br>		<span class="hljs-keyword">int</span> step = img.step;<br>		<span class="hljs-keyword">int</span> h = img.rows;<br>		<span class="hljs-keyword">int</span> w = img.cols;<br>		<span class="hljs-keyword">int</span> c = img.<span class="hljs-built_in">channels</span>();<br>		std::cout &lt;&lt; step&lt;&lt; std::endl;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; c; k++)<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; h; i++)<br>				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; w; j++)<br>				&#123;<br>					<span class="hljs-comment">//两种写法</span><br>					<span class="hljs-comment">//fwrite(&amp;img.data[i*step + j * c + k], sizeof(uint8_t), 1, fp);</span><br>					<span class="hljs-built_in">fwrite</span>(&amp;img.data[c*(i * w + j) + k], <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">uint8_t</span>), <span class="hljs-number">1</span>, fp);<br>				&#125;<br>		<span class="hljs-built_in">fclose</span>(fp);<br>		<span class="hljs-comment">//cv::Mat tmp;</span><br>		<span class="hljs-comment">//bgr2mat(tmp, w, h, 3, bgr_path);</span><br>		<span class="hljs-comment">//cv::imshow(&quot;tmp&quot;, tmp);</span><br>		<span class="hljs-comment">//cv::waitKey(0);</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="63-模型额外问题"><a class="markdownIt-Anchor" href="#63-模型额外问题"></a> 6.3 模型额外问题</h2>
<p>pc上运行</p>
<p>E:\Code\nnie\software\sample_simulator\Release\sample_simulator.exe</p>
<p>板上运行</p>
<p>/nfsroot/Hi3516CV500_SDK_V2.0.1.0/smp/a7_linux/mpp/sample/svp/nnie # ./sample_nnie_main 4</p>
<p>可能会出现如下（Fig.6.5，Fig.6.6）错误，原因是生成NNIE wk文件的mapper工具有版本要求，下面错误当中使用的nnie mapper 版本是V1.1.2.0，而指令仿真或者是板上的SDK是V1.2的，解决办法就是使用nnie mapper V1.2版本重新生成一下wk模型，如（Fig.6.7），生成inst/chip.wk的时间比较久，在我机器上大概要2个小时，因为inst.wk实际上是需要进行参数压缩和二进制代码生成，这可能也是inst.mk比func.wk文件大的原因（如Fig.6.8），而生成func.wk的时间会比较短，建议在PC上调试的时候选择func/simulation模型</p>
<p><img src="https://img-blog.csdnimg.cn/20200530160104437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.5 PC运行仿真例程sample_simulator会出现该log" /><br />
<img src="https://img-blog.csdnimg.cn/2020053016011611.png" alt="Fig.6.6 板上测试SDK修改的例程" /><br />
<img src="https://img-blog.csdnimg.cn/20200530160127275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.7 改变工程依赖的NNIE版本为指定芯片" /></p>
<p><img src="https://img-blog.csdnimg.cn/20200530160139775.png" alt="Fig.6.8 模型尺寸比较" /><br />
<img src="https://img-blog.csdnimg.cn/20200530160149255.png" alt="HISI 开发文档的提示" /></p>
<h2 id="64-运行结果及分析"><a class="markdownIt-Anchor" href="#64-运行结果及分析"></a> 6.4 运行结果及分析</h2>
<p>修改完sample_nnie.c中的代码后，在宿主机上进行make，然后到海思板子上运行可执行文件即可</p>
<p><img src="https://img-blog.csdnimg.cn/20200530160241112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.9 板上运行结果" /><br />
拷贝出生成的两个打印报表文件到Ruyi studio，进行比对测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">seg0_layer38_output0_inst.linear.hex<br>seg0_layer3605_output0_inst.linear.hex<br></code></pre></td></tr></table></figure>
<p>如Fig.6.10，Fig.6.11，虽然说板上和仿真情况下还是会有一定的差别，但总体的误差是比较小的，基本可以接受，如果无法接受，可以尝试int16模型</p>
<p><img src="https://img-blog.csdnimg.cn/20200530160314681.png" alt="结果向量的对比" /><br />
<img src="https://img-blog.csdnimg.cn/20200530160336993.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.10 量化模型在板子上的输出结果和pc上的结果比对（cosine similarity 99.6）" /><br />
<img src="https://img-blog.csdnimg.cn/20200530160405228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rfc29ydA==,size_16,color_FFFFFF,t_70" alt="Fig.6.11 无量化caffe输出与板上量化输出比对（cosine similarity  99.1）" /></p>
<h1 id="7-附录"><a class="markdownIt-Anchor" href="#7-附录"></a> 7. 附录</h1>
<figure class="highlight c++"><table><tr><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SAMPLE_SVP_NNIE_Cnn</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    HI_CHAR *pcSrcFile = <span class="hljs-string">&quot;./data/nnie_image/rgb_planar/10.bgr&quot;</span>;<br>    HI_CHAR *pcModelName = <span class="hljs-string">&quot;./data/nnie_model/face/mobilefacenet_inst.wk&quot;</span>;<br>    HI_U32 u32PicNum = <span class="hljs-number">1</span>;<br>    HI_S32 s32Ret = HI_SUCCESS;<br>    SAMPLE_SVP_NNIE_CFG_S   stNnieCfg = &#123;<span class="hljs-number">0</span>&#125;;<br>    SAMPLE_SVP_NNIE_INPUT_DATA_INDEX_S stInputDataIdx = &#123;<span class="hljs-number">0</span>&#125;;<br>    SAMPLE_SVP_NNIE_PROCESS_SEG_INDEX_S stProcSegIdx = &#123;<span class="hljs-number">0</span>&#125;;<br><br>    <span class="hljs-comment">/*Set configuration parameter*/</span><br>    stNnieCfg.pszPic= pcSrcFile;<br>    stNnieCfg.u32MaxInputNum = u32PicNum; <span class="hljs-comment">//max input image num in each batch</span><br>    stNnieCfg.u32MaxRoiNum = <span class="hljs-number">0</span>;<br>    stNnieCfg.aenNnieCoreId[<span class="hljs-number">0</span>] = SVP_NNIE_ID_0;<span class="hljs-comment">//set NNIE core</span><br>    s_stCnnSoftwareParam.u32TopN = <span class="hljs-number">5</span>;<br><br>    <span class="hljs-comment">/*Sys init*/</span><br>    <span class="hljs-built_in">SAMPLE_COMM_SVP_CheckSysInit</span>();<br><br>    <span class="hljs-comment">/*CNN Load model*/</span><br>    <span class="hljs-built_in">SAMPLE_SVP_TRACE_INFO</span>(<span class="hljs-string">&quot;Cnn Load model!\n&quot;</span>);<br>    s32Ret = <span class="hljs-built_in">SAMPLE_COMM_SVP_NNIE_LoadModel</span>(pcModelName,&amp;s_stCnnModel);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_0,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_COMM_SVP_NNIE_LoadModel failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*CNN parameter initialization*/</span><br>    <span class="hljs-comment">/*Cnn software parameters are set in SAMPLE_SVP_NNIE_Cnn_SoftwareParaInit,</span><br><span class="hljs-comment">     if user has changed net struct, please make sure the parameter settings in</span><br><span class="hljs-comment">     SAMPLE_SVP_NNIE_Cnn_SoftwareParaInit function are correct*/</span><br>    <span class="hljs-built_in">SAMPLE_SVP_TRACE_INFO</span>(<span class="hljs-string">&quot;Cnn parameter initialization!\n&quot;</span>);<br>    s_stCnnNnieParam.pstModel = &amp;s_stCnnModel.stModel;<br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_Cnn_ParamInit</span>(&amp;stNnieCfg,&amp;s_stCnnNnieParam,&amp;s_stCnnSoftwareParam);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_0,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_Cnn_ParamInit failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*record tskBuf*/</span><br>    s32Ret = <span class="hljs-built_in">HI_MPI_SVP_NNIE_AddTskBuf</span>(&amp;(s_stCnnNnieParam.astForwardCtrl[<span class="hljs-number">0</span>].stTskBuf));<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_0,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,HI_MPI_SVP_NNIE_AddTskBuf failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*Fill src data*/</span><br>    <span class="hljs-built_in">SAMPLE_SVP_TRACE_INFO</span>(<span class="hljs-string">&quot;Cnn start!\n&quot;</span>);<br>    stInputDataIdx.u32SegIdx = <span class="hljs-number">0</span>;<br>    stInputDataIdx.u32NodeIdx = <span class="hljs-number">0</span>;<br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_FillSrcData</span>(&amp;stNnieCfg,&amp;s_stCnnNnieParam,&amp;stInputDataIdx);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_1,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_FillSrcData failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*NNIE process(process the 0-th segment)*/</span><br>    stProcSegIdx.u32SegIdx = <span class="hljs-number">0</span>;<br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_Forward</span>(&amp;s_stCnnNnieParam,&amp;stInputDataIdx,&amp;stProcSegIdx,HI_TRUE);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_1,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_Forward failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*Software process*/</span><br>    <span class="hljs-comment">/*if user has changed net struct, please make sure SAMPLE_SVP_NNIE_Cnn_GetTopN</span><br><span class="hljs-comment">     function&#x27;s input datas are correct*/</span><br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_Cnn_GetTopN</span>(&amp;s_stCnnNnieParam,&amp;s_stCnnSoftwareParam);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_1,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_CnnGetTopN failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*Print result*/</span><br>    <span class="hljs-built_in">SAMPLE_SVP_TRACE_INFO</span>(<span class="hljs-string">&quot;Cnn result:\n&quot;</span>);<br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_Cnn_PrintResult</span>(&amp;(s_stCnnSoftwareParam.stGetTopN),<br>        s_stCnnSoftwareParam.u32TopN);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_1,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_Cnn_PrintResult failed!\n&quot;</span>);<br><br>    <span class="hljs-comment">/*Print results*/</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;features:\n&#123;\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stride: %d\n&quot;</span>,s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].u32Stride);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;blob type :%d\n&quot;</span>,s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].enType);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&#123;\n\tc :%d&quot;</span>, s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].unShape.stWhc.u32Chn);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n\th :%d&quot;</span>, s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].unShape.stWhc.u32Height);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n\tw :%d \n&#125;\n&quot;</span>, s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].unShape.stWhc.u32Width);<br>        HI_S32* ps32Score = (HI_S32* )((HI_U8* )s_stCnnNnieParam.astSegData[<span class="hljs-number">0</span>].astDst[<span class="hljs-number">0</span>].u64VirAddr);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;blobs fc1:\n[&quot;</span>);<br>        <span class="hljs-keyword">for</span>(HI_U32 i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f ,&quot;</span>,*(ps32Score + i) / <span class="hljs-number">4096.f</span>);<br>        &#125;<br>        <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;]\n&#125;\n&quot;</span>);<br>    &#125;<br>    s32Ret = <span class="hljs-built_in">SAMPLE_SVP_NNIE_PrintReportResult</span>(&amp;s_stCnnNnieParam);<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret, CNN_FAIL_1, SAMPLE_SVP_ERR_LEVEL_ERROR,<span class="hljs-string">&quot;Error,SAMPLE_SVP_NNIE_PrintReportResult failed!&quot;</span>);<br><br>CNN_FAIL_1:<br>    <span class="hljs-comment">/*Remove TskBuf*/</span><br>    s32Ret = <span class="hljs-built_in">HI_MPI_SVP_NNIE_RemoveTskBuf</span>(&amp;(s_stCnnNnieParam.astForwardCtrl[<span class="hljs-number">0</span>].stTskBuf));<br>    <span class="hljs-built_in">SAMPLE_SVP_CHECK_EXPR_GOTO</span>(HI_SUCCESS != s32Ret,CNN_FAIL_0,SAMPLE_SVP_ERR_LEVEL_ERROR,<br>        <span class="hljs-string">&quot;Error,HI_MPI_SVP_NNIE_RemoveTskBuf failed!\n&quot;</span>);<br><br>CNN_FAIL_0:<br>    <span class="hljs-built_in">SAMPLE_SVP_NNIE_Cnn_Deinit</span>(&amp;s_stCnnNnieParam,&amp;s_stCnnSoftwareParam,&amp;s_stCnnModel);<br>    <span class="hljs-built_in">SAMPLE_COMM_SVP_CheckSysExit</span>();<br>&#125;<br></code></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>海思NNIE之Mobilefacenet量化部署</p><p><a href="http://example.com/2020/03/04/海思NNIE之Mobilefacenet量化部署/">http://example.com/2020/03/04/海思NNIE之Mobilefacenet量化部署/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>John Doe</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-03-04</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-06-21</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/nniefacelib/">nniefacelib</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60cf6ea5159fbe001904dc09&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/img/alipay.jpg" alt="Alipay"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/img/wxpay.jpg" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/03/06/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BRetinaFace%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">海思NNIE之RetinaFace量化部署</span></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="SOHUCS" sid="2020/03/04/海思NNIE之Mobilefacenet量化部署/"></div><script charset="utf-8" src="https://changyan.sohu.com/upload/changyan.js"></script><script>window.changyan.api.config({appid: 'cyvw2kgH3',conf: 'prod_9c13a75ae14df21f1a65fe8c164aefeb'});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/logo.jpg" alt="Hanson"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Hanson</p><p class="is-size-6 is-block">放眼望去，是星辰大海，而我是咸鱼</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Category</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tag</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/hanson-young" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/hanson-young"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="ZhiHu" href="https://www.zhihu.com/people/yang-jian-41-76"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hanson-young.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">GitHub</span></span><span class="level-right"><span class="level-item tag">hanson-young.github.io</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/people/yang-jian-41-76" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ZhiHu</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">技术</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/nniefacelib/"><span class="tag">nniefacelib</span><span class="tag">3</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8344814726705993" data-ad-slot="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#0-前言"><span class="level-left"><span class="level-item"> 0. 前言</span></span></a></li><li><a class="level is-mobile" href="#1-简介"><span class="level-left"><span class="level-item"> 1. 简介</span></span></a></li><li><a class="level is-mobile" href="#2-目录结构"><span class="level-left"><span class="level-item"> 2. 目录结构</span></span></a></li><li><a class="level is-mobile" href="#3-mobilefacenetcfg文件的配置"><span class="level-left"><span class="level-item"> 3. mobilefacenet.cfg文件的配置</span></span></a></li><li><a class="level is-mobile" href="#4-生成nnie-mk模型"><span class="level-left"><span class="level-item"> 4. 生成NNIE mk模型</span></span></a></li><li><a class="level is-mobile" href="#5-vector-comparision"><span class="level-left"><span class="level-item"> 5. Vector Comparision</span></span></a></li><li><a class="level is-mobile" href="#6-nnie-mobilefacenet板上特征提取"><span class="level-left"><span class="level-item"> 6. NNIE mobilefacenet板上特征提取</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#61-修改例程"><span class="level-left"><span class="level-item"> 6.1 修改例程</span></span></a></li><li><a class="level is-mobile" href="#62-bgr文件的生成"><span class="level-left"><span class="level-item"> 6.2 bgr文件的生成</span></span></a></li><li><a class="level is-mobile" href="#63-模型额外问题"><span class="level-left"><span class="level-item"> 6.3 模型额外问题</span></span></a></li><li><a class="level is-mobile" href="#64-运行结果及分析"><span class="level-left"><span class="level-item"> 6.4 运行结果及分析</span></span></a></li></ul></li><li><a class="level is-mobile" href="#7-附录"><span class="level-left"><span class="level-item"> 7. 附录</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/2021/01/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BPFPLD%E8%AE%AD%E7%BB%83%E4%B8%8E%E9%87%8F%E5%8C%96/"><img src="https://pic4.zhimg.com/v2-aad87f07e2bb74dce5641a23b321bf58_1440w.jpg?source=172ae18b" alt="海思NNIE之PFPLD训练与量化"></a></figure><div class="media-content"><p class="date"><time dateTime="2021-01-04T09:42:26.000Z">2021-01-04</time></p><p class="title"><a href="/2021/01/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BPFPLD%E8%AE%AD%E7%BB%83%E4%B8%8E%E9%87%8F%E5%8C%96/">海思NNIE之PFPLD训练与量化</a></p><p class="categories"><a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/03/06/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BRetinaFace%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"><img src="https://pic4.zhimg.com/v2-d5c18e2e8325429250485a6a326bfe28_1440w.jpg?source=172ae18b" alt="海思NNIE之RetinaFace量化部署"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-03-06T09:42:13.000Z">2020-03-06</time></p><p class="title"><a href="/2020/03/06/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BRetinaFace%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/">海思NNIE之RetinaFace量化部署</a></p><p class="categories"><a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/03/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BMobilefacenet%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/"><img src="https://pic4.zhimg.com/v2-41222c094c3f00a034d46ccef7d35dd6_r.jpg" alt="海思NNIE之Mobilefacenet量化部署"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-03-04T09:41:47.000Z">2020-03-04</time></p><p class="title"><a href="/2020/03/04/%E6%B5%B7%E6%80%9DNNIE%E4%B9%8BMobilefacenet%E9%87%8F%E5%8C%96%E9%83%A8%E7%BD%B2/">海思NNIE之Mobilefacenet量化部署</a></p><p class="categories"><a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.jpg" alt="Hanson&#039;s Happy Days" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>